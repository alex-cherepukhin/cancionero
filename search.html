<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <title>Canciones</title>
    <link rel="stylesheet" href="index_styles.css">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <a href="https://www.iglesialuzalasnaciones.es/" target="_blank">
                <img src="iglesia.png" alt="Luz a las naciones">
            </a>
            <h1>Canciones</h1>
        </div>
        <nav class="alpha-nav">
            <a href="../index.html">Índice</a>
            <input type="text" id="searchBar" placeholder="Texto de búsqueda">
            <button id="searchButton">&nbsp;Buscar&nbsp;</button>
        </nav>
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
    <script>
        let idx; // Глобальная переменная для индекса
        let songsData; // Глобальная переменная для данных песен

        // Загрузка JSON-файла и создание индекса
        fetch('songs.json')
            .then(response => response.json())
            .then(data => {
                songsData = data; // Сохраняем данные в глобальную переменную
                console.log("Данные песен загружены:", songsData); // Отладка: проверяем загрузку

                idx = lunr(function () {
                    this.field('title');
                    this.field('text');
                    this.ref('id');

                    data.forEach(song => {
                        this.add(song);
                    });
                });
                console.log("Индекс Lunr создан:", idx); // Отладка: проверяем создание индекса

                // Добавляем обработчики событий (лучше здесь, после загрузки данных)
                document.getElementById('searchButton').addEventListener('click', performSearch);
                document.getElementById('searchBar').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            })
            .catch(error => {
                console.error("Ошибка загрузки songs.json:", error); // Отладка ошибок загрузки
            });

        // Функция для выполнения поиска
        function performSearch() {
            console.log("Функция performSearch вызвана"); // Отладка: проверяем вызов функции
            const query = document.getElementById('searchBar').value;
            console.log("Запрос:", query); // Отладка: проверяем введенный запрос

            if (!idx) {
                console.error("Индекс Lunr не инициализирован!"); // Отладка: проверка инициализации индекса
                document.getElementById('results').innerHTML = '<p>Поиск невозможен, индекс не загружен.</p>';
                return; // Прерываем выполнение функции
            }

            const results = idx.search('"'+query+'"'); // Точные совпадения
            console.log("Результаты поиска Lunr:", results); // Отладка: проверяем результаты поиска

            const resultContainer = document.getElementById('results');
            resultContainer.innerHTML = ''; // Очистка предыдущих результатов

            if (results.length === 0) {
                resultContainer.innerHTML = '<p>No se encontraron resultados.</p>';
            } else {
                results.forEach(result => {
                    const song = songsData.find(song => song.id === result.ref); // Используем songsData
                    console.log("Найденная песня:", song); // Отладка: проверяем найденную песню

                    if (song) { // Проверка, что песня найдена
                      const link = document.createElement('a');
                      link.href = song.url;
                      link.textContent = song.title;
                      link.target = '_blank';
                      resultContainer.appendChild(link);
                      resultContainer.appendChild(document.createElement('br'));
                    } else {
                      console.error("Песня с id " + result.ref + " не найдена в songsData!");
                      resultContainer.innerHTML += '<p style="color:red;">Ошибка: внутренняя ошибка поиска.</p>';
                    }
                });
            }
        }
    </script>
</body>
</html>